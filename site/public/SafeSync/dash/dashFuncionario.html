<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="imagem/png" href="../assets/img/logotipo.svg">
    <link rel="stylesheet" href="dashFuncionario.css">
    <link rel="stylesheet" href="./tarefas.css">
    <title>Dashboard</title>
</head>

<body>
    <main>

        <article>
            <nav class="menu-lateral" id="botao-expandir">
                <div class="botao_expandir">
                    <!-- <i class="bi bi-music-note-list" id="botao-expandir"></i> -->
                    <img src="../assets/img/logotipo.svg" alt="" width="60px">
                </div>
                <ul>
                    <li class="item-menu ativo" id="dashboard-link">
                        <a href="#">
                            <span class="icon">
                                <svg xmlns="http://www.w3.org/2000/svg" height="1.4em" fill="currentColor"
                                    class="bi bi-bar-chart-fill" viewBox="0 0 16 16">
                                    <path
                                        d="M1 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3zm5-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2z" />
                                </svg>
                            </span>
                            <span class="txt-link">Dashboard</span>
                        </a>
                    </li>
                    <li class="item-menu" id="tarefas-link">
                        <a href="#">
                            <span class="icon">
                                <svg xmlns="http://www.w3.org/2000/svg" height="1.4em" fill="currentColor"
                                    class="bi bi-journal-bookmark-fill" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                        d="M6 1h6v7a.5.5 0 0 1-.757.429L9 7.083 6.757 8.43A.5.5 0 0 1 6 8V1z" />
                                    <path
                                        d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2z" />
                                    <path
                                        d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1z" />
                                </svg>
                            </span>
                            <span class="txt-link tasks-link">Tasks</span>
                        </a>
                    </li>


                    <li class="item-menu" id="item-menu-sair" onclick="window.location.href='../index.html'">
                        <a href="#">
                            <span class="icon-sair">
                                <svg xmlns="http://www.w3.org/2000/svg" height="1.4em" fill="rgb(151, 16, 16)"
                                    class="bi bi-box-arrow-left" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                        d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0v2z" />
                                    <path fill-rule="evenodd"
                                        d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z" />
                                </svg>
                            </span>
                            <span class="txt-link-sair">Sair</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </article>

        <article id="dash">
            <header id="header">
                <div id="titulosDash">
                    <h1 class="titulo">Dashboard</h1>
                    <h3><span id="nome_funcionario"></span> - <span id="span_nome_empresa">Nome da empresa</span></h3>
                </div>
                <section class="opcoesTopo">
                    <div id="notificacao">
                        <svg xmlns="http://www.w3.org/2000/svg" height="1.4em"
                            viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
                            <path
                                d="M224 0c-17.7 0-32 14.3-32 32V51.2C119 66 64 130.6 64 208v18.8c0 47-17.3 92.4-48.5 127.6l-7.4 8.3c-8.4 9.4-10.4 22.9-5.3 34.4S19.4 416 32 416H416c12.6 0 24-7.4 29.2-18.9s3.1-25-5.3-34.4l-7.4-8.3C401.3 319.2 384 273.9 384 226.8V208c0-77.4-55-142-128-156.8V32c0-17.7-14.3-32-32-32zm45.3 493.3c12-12 18.7-28.3 18.7-45.3H224 160c0 17 6.7 33.3 18.7 45.3s28.3 18.7 45.3 18.7s33.3-6.7 45.3-18.7z" />
                        </svg>
                    </div>
                    <div id="usuario">
                        <svg xmlns="http://www.w3.org/2000/svg" height="1.4em"
                            viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
                            <path
                                d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z" />
                        </svg>
                    </div>
                </section>
            </header>
            <section id="areaGraficos">
                <article id="areaKpis">
                    <div class="kpi kpiTarefa">
                        <span class="tituloKpi">Tarefas Entregues no Mês</span>
                        <span class="kpiVerde valoresKpi" id="tarefasEntreguesFunc">0</span>
                    </div>
                    <div class="kpi kpiTarefa">
                        <span class="tituloKpi">Tarefas Pendentes</span>
                        <span class="kpiAmarela valoresKpi" id="tarefasPendentesFunc">0</span>
                    </div>
                    <div class="kpi kpiTarefa">
                        <span class="tituloKpi">Janelas Abertas</span>
                        <span class="valoresKpi kpiBranca" id="janelasAbertasFunc">7</span>
                    </div>
                    <div class="kpi kpiTarefa">
                        <span class="tituloKpi">N° de Alertas da máquina</span>
                        <span class="valoresKpi kpiVermelha" id="alertasMaquinaFunc">8</span>
                    </div>
                </article>
                <section>
                    <div class="graficos cpu">
                        <h3>Uso de Cpu</h3>
                        <div>
                            <canvas id="myChartLineCpu"></canvas>
                        </div>
                    </div>
                    <div class="graficos tarefas">
                        <h3>Tarefas atribuidas e entregues durante a semana </h3>
                        <div>
                            <canvas id="myChartLineTarefas"></canvas>
                        </div>
                    </div>
                    <div class="graficos disco">
                        <h3>Uso de Disco</h3>
                        <div>
                            <canvas id="myChartLineDisco"></canvas>
                        </div>

                    </div>
                    <div class="graficos ram">
                        <h3>Uso de Ram</h3>
                        <div>
                            <canvas id="myChartLineRam"></canvas>
                        </div>
                    </div>
                </section>
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

            </section>

            <section id="areaTarefas" class="sectionsSumir" style="display: none;">
                <div class="accordion-container">
                    <div class="nomeLista">
                        <h1>GESTÃO DE TAREFAS</h1>
                    </div>
                    <div class="task-input">
                        <input type="text" id="taskInput" placeholder="Digite uma nova tarefa">
                        <label for="taskDate">Data de Entrega:</label>
                        <input type="date" id="taskDate">
                        <button onclick="addTask()">Adicionar Tarefa</button>
                    </div>
                    <div class="accordion" id="accordion">
                        <div class="accordion-item" id="tarefas" ondragover="allowDrop(event)" ondrop="drop(event)">
                            <div class="accordion-header" id="headerTarefas">Tarefas</div>
                            <div class="accordion-content" id="tarefasContent"></div>
                        </div>
                        <div class="accordion-item" id="afazer" ondrop="drop(event)" ondragover="allowDrop(event)">
                            <div class="accordion-header" id="headerAfazer">A Fazer</div>
                            <div class="accordion-content" id="afazerContent"></div>
                        </div>
                        <div class="accordion-item" id="andamento" ondrop="drop(event)" ondragover="allowDrop(event)">
                            <div class="accordion-header" id="headerAndamento">Em Andamento</div>
                            <div class="accordion-content" id="andamentoContent"></div>
                        </div>
                        <div class="accordion-item" id="concluido" ondrop="drop(event)" ondragover="allowDrop(event)">
                            <div class="accordion-header" id="headerConcluido">Concluído</div>
                            <div class="accordion-content" id="concluidoContent"></div>
                        </div>
                    </div>
                </div>
            </section>

            <div id="modalNotificacao" class="notificacaoModal">
                <div class="notificacaoModal-content">
                    <span class="closeNotificacao">&times;</span>
                    <!-- Conteúdo do modal aqui -->
                    <!-- Seu conteúdo modal aqui... -->
                    <section>
                        <div class="notificacaoCritico" id="alerta_P">
                            <!-- <p alerta_span>Uso da CPU crítico, acima dos 90%</p> -->

                        </div>
                        <!-- <div class="notificacaoBom">
                            <p>Uso da CPU bom, abaixo dos 50%</p>
                        </div>
                        <div class="notificacaoAlerta">
                            <p>Uso da CPU em alerta, acima dos 70%</p>
                        </div>
                        <div class="notificacaoAlerta">
                            <p>Uso da CPU em alerta, acima dos 70%</p>
                        </div>
                        <div class="notificacaoAlerta">
                            <p>Uso da CPU em alerta, acima dos 70%</p>
                        </div>
                        <div class="notificacaoAlerta">
                            <p>Uso da CPU em alerta, acima dos 70%</p>
                        </div>
                        <div class="notificacaoAlerta">
                            <p>Uso da CPU em alerta, acima dos 70%</p>
                        </div>
                        <div class="notificacaoAlerta">
                            <p>Uso da CPU em alerta, acima dos 70%</p>
                        </div>
                        <div class="notificacaoAlerta">
                            <p>Uso da CPU em alerta, acima dos 70%</p>
                        </div> -->
                        <!-- <div class="notificacaoAlerta">
                            <p onclick="window.location.href='./dashFuncionario.html'">Uso da CPU em alerta, acima dos
                                70%</p>
                        </div> -->

                    </section>
                </div>
            </div>

            <div id="modalUsuario" class="usuarioModal">
                <div class="usuarioModal-content">
                    <span class="closeUsuario"></span>
                    <section>
                        <h1>Meu Perfil</h1>

                        <article>
                            <!-- <div id="imgPerfil"> <img src="../assets/img/exemploModelo.svg" alt=""></div> -->


                            <div class="conteudoPerfil">
                                <div class="iconeEditarPerfil"><svg xmlns="http://www.w3.org/2000/svg" width="16"
                                        height="16" fill="currentColor" class="bi bi-pencil-fill" viewBox="0 0 16 16">
                                        <path
                                            d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z" />
                                    </svg></div>
                                <p class="legendaPerfil primeiraLegenda">Nome</p>
                                <p class="campoPerfil" id="perfil_nome"></p>
                                <p class="legendaPerfil">Cargo</p>
                                <p class="campoPerfil" id="perfil_cargo"></p>
                                <p class="legendaPerfil">Email</p>
                                <p class="campoPerfil" id="perfil_email"></p>
                            </div>
                        </article>
                    </section>
                </div>
            </div>

        </article>
    </main>
    <script src="./script/tarefas.js"></script>
    <script src="./script/allGraficos.js"></script>
</body>

</html>
<script src="./script/dash.js"></script>


<script>

    var nomeFuncionario = sessionStorage.NOME_FUNCIONARIO;
    var cargoFuncionario = sessionStorage.CARGO_FUNCIONARIO;
    var emailFuncionario = sessionStorage.EMAIL_FUNCIONARIO;
    var idFuncionario = sessionStorage.ID_FUNCIONARIO;

    nome_funcionario.innerHTML = nomeFuncionario;
    perfil_nome.innerHTML = nomeFuncionario;
    perfil_cargo.innerHTML = cargoFuncionario;
    perfil_email.innerHTML = emailFuncionario;




    let proximaAtualizacao;
    var cpu;
    function graficoCPU(idHardware) {

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        if (idHardware == undefined) {
            console.log("id do funcionário undefined");
        } else {
            fetch(`/medidas/graficoCPU/${idHardware}`).then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        resposta.reverse();



                        for (var i = 0; i < resposta.length; i++) {

                            var data = resposta[i].ultima_data;
                            cpu = resposta[i].consumoCpu;
                            console.log(`cpu do grafico Cpu: ${cpu}`);

                            if (dados.labels.length >= 7) {
                                dados.labels.shift();
                                dados.datasets[0].data.shift();
                            }
                            dados.labels.push(data);
                            dados.datasets[0].data.push(parseInt(cpu));
                        }
                        chartCpu.update();


                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            }).catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
        }

    }

    var consumo;
    function graficoRAM(idHardware) {

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        if (idHardware == undefined) {
        } else {
            fetch(`/medidas/graficoRAM/${idHardware}`).then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        resposta.reverse();


                        for (var i = 0; i < resposta.length; i++) {

                            var data = resposta[i].ultima_data;
                            var Ram = resposta[i].consumoRam;
                            consumo = ((Ram * 100) / resposta[i].totalRam); // 8 = 100

                            if (dadosRam.labels.length >= 7) {
                                dadosRam.labels.shift();
                                dadosRam.datasets[0].data.shift();
                            }
                            dadosRam.labels.push(data);
                            dadosRam.datasets[0].data.push(parseInt(consumo));
                        }

                        chartRam.update();


                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            }).catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
        }

    }

    var discoUsado = 0;
    var discoTotal = 0;
    var discoLivre = 0;
    function graficoDISCO(idHardware) {
        console.log(`id do hardware: ${idHardware}`);

        fetch(`/medidas/graficoDISCO/${idHardware}`).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {

                    if (resposta.length > 0) {

                        discoTotal = resposta[0].totalDisco;
                        discoUsado = resposta[0].consumoDisco;
                        discoLivre = discoTotal - discoUsado;

                        dashDisco(parseInt(discoUsado), parseInt(discoLivre));
                    }
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        }).catch(function (error) {
            console.error(`Erro na obtenção dos dados: ${error.message}`);
        });
    }
    var totalAlertas = 0;

    function dadosEmpresa(idFuncionario) {


        fetch(`/medidas/dadosEmpresa/${idFuncionario}`).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {

                    if (resposta.length > 0) {
                        var idEmpresa = resposta[0].idEmpresa;
                        var nomeEmpresa = resposta[0].nomeFantasia;

                        console.log(`
                        id da empresa: ${idEmpresa}
                        nomeEmpresa: ${nomeEmpresa}
                        `);
                        span_nome_empresa.innerHTML = `${nomeEmpresa}`

                        setInterval(function () {
                            dadosAlertas(idEmpresa);
                        }, 10000);
                    }
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        }).catch(function (error) {
            console.error(`Erro na obtenção dos dados: ${error.message}`);
        });
    }
    dadosEmpresa(idFuncionario);

    var alertCpu = 0;
    var alertRam = 0;
    var alertDisco = 0;
    function dadosAlertas(idEmpresa) {
        fetch(`/medidas/alertas/${idEmpresa}/${idFuncionario}`).then(function (response) {
            console.log(idEmpresa + " id da empresa");
            if (response.ok) {
                response.json().then(function (alertas) {


                    if (alertas.length > 0) {

                        var idLimitador = alertas[0].idLimitador;

                        console.log(idLimitador+"idLimitador");

                        alertCpu = alertas[0].maxCpu;
                        alertRam = alertas[0].maxRam;
                        alertDisco = alertas[0].maxDisco;
                        var CPU = parseInt(cpu);
                        var RAM = parseInt(consumo);
                        var DISCO = parseInt(discoUsado);

                        // console.log(`
                        //         idEmpresa = ${idEmpresa}
                        //         alertaCpu = ${alertCpu}
                        //         alertaRam = ${alertRam}
                        //         alertaDisco = ${alertDisco}
                        //         CPU = ${CPU}
                        //         RAM = ${RAM}
                        //         DISCO = ${DISCO}
                        //         `);

                        if (CPU > alertCpu) {
                            console.log("Entrei no if da cpu");
                            alerta_P.innerHTML += `<P class="notificacaoCritico">SUA CPU ENTROU NO ALERTA</span>`
                            totalAlertas++
                        }
                        if (RAM > alertRam) {
                            alerta_P.innerHTML += `<P class="notificacaoCritico">SUA RAM ENTROU NO ALERTA</span>`
                            totalAlertas++
                        }
                        if (DISCO > alertDisco) {
                            alerta_P.innerHTML += `<P class="notificacaoCritico">SEU DISCO ENTROU NO ALERTA</span>`
                            totalAlertas++
                        }
                    }


                    console.log(totalAlertas + " Total de alertas");
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        }).catch(function (error) {
            console.error(`Erro na obtenção dos dados: ${error.message}`);
        });
    }

    function graficoTAREFA(idFuncionario) {

        fetch(`/medidas/graficoTAREFA/${idFuncionario}`).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {

                    // debugger
                    for(i = 0; i < resposta.length; i++){
                        var dia = resposta[i].diaDaSemana;
                        var tarefasPendentes = resposta[i].tarefas_nao_concluidas;
                        var tarefasConcluidas = resposta[i].tarefas_concluidas;

                        console.log(`
                            dia: ${dia}
                            concluidas: ${tarefasConcluidas}
                            pendentes: ${tarefasPendentes}
                        `);

                        dadosTarefa.labels.push(dia);
                        dadosTarefa.datasets[0].data.push(tarefasPendentes)
                        dadosTarefa.datasets[1].data.push(tarefasConcluidas)

                    }
                    chartTarefa.update()
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        }).catch(function (error) {
            console.error(`Erro na obtenção dos dados: ${error.message}`);
        });
    }

    // console.log("id do funcionario passado como parametro: " + idFuncionario);
    graficoCPU(idFuncionario);
    graficoRAM(idFuncionario);
    graficoDISCO(idFuncionario);
    graficoTAREFA(idFuncionario);

    setInterval(function () {
        graficoCPU(idFuncionario);
        graficoRAM(idFuncionario);
        graficoDISCO(idFuncionario);
    }, 10000);


   

    function tarefasEntregues() {
        var idFuncionario = sessionStorage.ID_FUNCIONARIO;
        fetch(`/kpiFuncionario/tarefasEntregues/${idFuncionario}`)
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (tarefas) {

                        tarefasEntreguesFunc.innerHTML = tarefas[0].total_tarefas_entregues;
                    });
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados: ${error.message}`);
            });
    }
    tarefasEntregues();

    function tarefasPendentes() {
        var idFuncionario = sessionStorage.ID_FUNCIONARIO;
        fetch(`/kpiFuncionario/tarefasPendentes/${idFuncionario}`)
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (tarefas) {

                        tarefasPendentesFunc.innerHTML = tarefas[0].total_tarefas_entregues;
                    });
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados: ${error.message}`);
            });
    }
    tarefasPendentes();

</script>